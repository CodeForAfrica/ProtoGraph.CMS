<%= render partial: "pages/header" %>
<div class="row">
    <p>
        The Landing page has 5 streams: 16-column, 7-column, 4-column, 2-column and 3-column. To edit their names, simply click on it, a text box will appear. The left most column has 'all published stories and cards'. The best way to find a story or card is to fetch it's card ID and Ctrl+F search it by id. To add a story or card to a stream, hover over it to unveil the list of streams and click on relevant stream. To remove a story from a stream, click on Remove link. All cards and stories will be sorted by published datetime.
    </p>
</div>
<div class="row">
    <div class="col-sm-4">
        <br/>
        <br/>
        <h3 style="padding-left: 15px;">All stories and cards</h3>
        <div style="background: #E8E8E8; width: 230px; height: 100%;">
            <% @all_cards.each do |d| %>
              <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" style='width: 180px; margin-bottom: 10px;'>
                <div class="card-information">
                  <div class="card-title"><%= truncate(d.name, length: 200, ommission: "..") %></div>
                  <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
                  <div class="card-footer">
                    <div class="users-list">
                      <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                    </div>
                    <div class="due-on">
                      <%= time_ago_in_words(d.published_at) %>
                    </div>
                  </div>
                </div>
                <div class="call-to-action">
                  <% if (d.is_autogenerated and d.page.present?) %>
                    <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                      <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                      <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                    <% else %>
                      <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                      <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                    <% end %>
                  <% else %>
                    <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                    <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                      <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                    <% end %>
                  <% end %>
                </div>
                <div class="action-move-to">
                  <div class="hint-text">Move To</div>
                  <br>
                  <ul class="list-group list-group-flush">
                    <% if (["col16", "col4"] - d.template_card.allowed_views).blank? %>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_16) %>"><%= @page_streamH16.name_of_stream %></li>
                    <% end %>
                    <% if (["col7", "col4"] - d.template_card.allowed_views).blank? %>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_07) %>"><%= @page_streamH07.name_of_stream %></li>
                    <% end %>

                    <% if (d.template_card.allowed_views & ["col4"]).present? %>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_04) %>"><%= @page_streamH04.name_of_stream %></li>
                    <% end %>

                    <% if (d.template_card.allowed_views & ["col2"]).present? %>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_02) %>"><%= @page_streamH02.name_of_stream %></li>
                    <% end %>

                    <% if (d.template_card.allowed_views & ["col3"]).present? %>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_03) %>"><%= @page_streamH03.name_of_stream %></li>
                    <% end %>
                    <% if ((["col16", "col4"] - d.template_card.allowed_views)).blank? %>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_cr) %>"><%= @page_streamHcr.name_of_stream %></li>
                      <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_cta) %>"><%= @page_streamHcta.name_of_stream %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>
        </div>
    </div>
    <div class="col-sm-12">
        <% @streams.each do |stream| %>
            <% page_stream = stream.page_streams.first %>
            <br/>
            <br/>
            <div class="row">
                <h3>Stream Title: <%= best_in_place page_stream, :name_of_stream, url: [@site, page_stream], style: "border-bottom: 1px dotted black;" %></h3>
                <p class="hint">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%= stream.title %></p>
                <div style="width: 100%; height: 220px; overflow-x: scroll !important; overflow-y:hidden; white-space: nowrap !important; -webkit-overflow-scrolling: touch; position: relative; background: #E8E8E8; padding: 15px 0px;">
                    <% stream.cards.each do |d| %>
                        <% stream_entity = stream.stream_entities.view_casts.where(entity_value: d.id).first %>
                        <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" data-stream-entity-id="<%= stream_entity.id %>" style='width: 180px; margin-right: 10px; position: relative; float: none; display: inline-block;'>
                          <div class="card-information">
                            <div class="card-title"><%= truncate(d.name, length: 200, ommission: "..") %></div>
                            <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
                            <div class="card-footer">
                              <div class="users-list">
                                <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                              </div>
                              <div class="due-on">
                                <%= time_ago_in_words(d.published_at) %>
                              </div>
                            </div>
                          </div>
                          <div class="call-to-action">
                            <% if (d.is_autogenerated and d.page.present?) %>
                              <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                                <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                                <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                              <% else %>
                                <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                                <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                              <% end %>
                            <% else %>
                              <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                              <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                                <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                              <% end %>
                            <% end %>
                          </div>
                          <div class="action-move-to">
                            <div class="hint-text">Move To</div>
                            <div class="remove-button">
                              <%= link_to "Remove", [@site, stream, stream_entity ], method: :delete %>
                            </div>
                            <br>
                            <ul class="list-group list-group-flush">
                              <% if (["col7", "col4"] - d.template_card.allowed_views).blank? %>
                                <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_07) %>"><%= @page_streamH07.name_of_stream %></li>
                              <% end %>

                              <% if (d.template_card.allowed_views & ["col4"]).present? %>
                                <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_04) %>"><%= @page_streamH04.name_of_stream %></li>
                              <% end %>

                              <% if (d.template_card.allowed_views & ["col2"]).present? %>
                                <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_02) %>"><%= @page_streamH02.name_of_stream %></li>
                              <% end %>

                              <% if (d.template_card.allowed_views & ["col3"]).present? %>
                                <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_03) %>"><%= @page_streamH03.name_of_stream %></li>
                              <% end %>
                              <% if ((["col16", "col4"] - d.template_card.allowed_views)).blank? %>
                                <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_cr) %>"><%= @page_streamHcr.name_of_stream %></li>
                                <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_cta) %>"><%= @page_streamHcta.name_of_stream %></li>
                              <% end %>
                            </ul>
                          </div>
                        </div>
                    <% end %>
                </div>

            </div>
        <% end %>
    </div>
</div>

<br/>
<hr class="hr-text" data-content="Streams on this page">
<% @streams.each do |stream| %>
    <% page_stream = stream.page_streams.first %>
    <br/>
    <div class="row" style="padding: 0px;">
        <h5>Stream: <%= best_in_place page_stream, :name_of_stream, url: [@site, page_stream], style: "border-bottom: 1px dotted black;" %></h5s>
        <p class="hint">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%= stream.title %></p>
        <div style="width: 100%; height: 200px; overflow-x: scroll !important; overflow-y:hidden; white-space: nowrap !important; -webkit-overflow-scrolling: touch; position: relative; padding: 10px 0px;">
            <% stream.cards.each do |d| %>
                <% stream_entity = stream.stream_entities.view_casts.where(entity_value: d.id).first %>
                <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" data-stream-entity-id="<%= stream_entity.id %>" style='width: 180px; margin-right: 10px; position: relative; float: none; display: inline-block;'>
                  <div class="card-information">
                    <div class="card-title" style="display: block; word-wrap: break-word;"><%= truncate(d.name, length: 200, ommission: "..") %></div>
                    <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
                    <div class="card-footer">
                      <div class="users-list">
                        <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                      </div>
                      <div class="due-on">
                        <%= time_ago_in_words(d.published_at) %>
                      </div>
                    </div>
                  </div>
                  <div class="call-to-action">
                    <% if (d.is_autogenerated and d.page.present?) %>
                      <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                        <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                        <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                      <% else %>
                        <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                        <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                      <% end %>
                    <% else %>
                      <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                      <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                        <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                      <% end %>
                    <% end %>
                  </div>
                  <div class="action-move-to">
                    <div class="hint-text">Move To</div>
                    <div class="remove-button">
                      <%= link_to "Remove", [@site, stream, stream_entity ], method: :delete %>
                    </div>
                    <br>
                    <ul class="list-group list-group-flush">
                      <% if (["col7", "col4"] - d.template_card.allowed_views).blank? %>
                        <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_07) %>"><%= @page_streamH07.name_of_stream %></li>
                      <% end %>

                      <% if (d.template_card.allowed_views & ["col4"]).present? %>
                        <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_04) %>"><%= @page_streamH04.name_of_stream %></li>
                      <% end %>

                      <% if (d.template_card.allowed_views & ["col2"]).present? %>
                        <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_02) %>"><%= @page_streamH02.name_of_stream %></li>
                      <% end %>

                      <% if (d.template_card.allowed_views & ["col3"]).present? %>
                        <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_03) %>"><%= @page_streamH03.name_of_stream %></li>
                      <% end %>
                      <% if ((["col16", "col4"] - d.template_card.allowed_views)).blank? %>
                        <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_cr) %>"><%= @page_streamHcr.name_of_stream %></li>
                        <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_cta) %>"><%= @page_streamHcta.name_of_stream %></li>
                      <% end %>
                    </ul>
                  </div>
                </div>
            <% end %>
        </div>
    </div>
<% end %>


<% if @page.status != 'draft' %>
  <%= simple_form_for(@stream_entity, url: [@site, @page_stream_07, @stream_entity]) do |f| %>
    <%= f.hidden_field :entity_value, id: "stream_view_cast_id" %>
    <%= f.hidden_field :entity_type, value: "view_cast_id" %>
    <%= f.hidden_field :is_excluded, value: false %>
    <%= f.hidden_field :remove_stream_entity_id, id: "remove_stream_entity_id" %>
  <% end %>
<% end %>




<script type="text/javascript">
  $(document).on("turbolinks:load",function() {
    $('.action-move-to .list-group li').off('click');
    $('.action-move-to .list-group li').on('click', function(){
      $("#new_stream_entity").attr("action", this.dataset.pageStreamUrl);
      $("#stream_view_cast_id").val($(this).parents('.card-as-a-todo').data().viewCastId);
      if($(this).parents('.card-as-a-todo').data().streamEntityId) {
          $("#remove_stream_entity_id").val($(this).parents('.card-as-a-todo').data().streamEntityId)
        }
      $("#new_stream_entity").submit();
    })
  });
  function readURL(input) {
   if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function (e) {
        $(input).css('background', 'transparent url('+e.target.result +') left top no-repeat');
      }
      reader.readAsDataURL(input.files[0]);
    }
  };
</script>