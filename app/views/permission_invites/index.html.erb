<%= content_for :page_title do %>
        <li class="breadcrumb-item"><%= link_to "Admin", account_site_admins_path(@account, @site), "data-turbolinks"=> false %></li>
        <li class="breadcrumb-item active" aria-current="page">Admin for Site: <%= @site.domain %></li>
        <li class="breadcrumb-item active" aria-current="page">Site Team</li>
<% end %>
<div class="row">
    <div class="col-sm-13">
        <div style="margin-left: auto; margin-right: auto; width: 500px;">
            <% if @permissions.first.blank? %>
                <p class="hint">No team members invited yet.</p>
            <% else %>
                <table class="table table-hover">
                    <tbody>
                        <% @permissions.each do |permission| %>
                            <tr>
                                <td style="width: 10%; border: 0px;"><img class="rounded" src=<%=avatar_url(permission.user.email)%>>
                                </td>
                                <td style="border: 0px;">
                                    <%= permission.user.name %>
                                    <% if permission.status == "Deactivated" %>
                                        <i style="font-weight: 200; color: gray;">(Deactivated)</i>
                                    <% end %>
                                    <br/>
                                    <div class="hint"><%= permission.user.email %></div>
                                    <% if permission.user.current_sign_in_at.present? %>
                                        <div class="hint">Last seen <%= time_ago_in_words(permission.user.current_sign_in_at) %> ago.</div>
                                    <% end %>
                                </td>
                                <td style="border: 0px;">
                                    <%= simple_form_for(permission, url: change_role_account_site_permission_path(@account, @site, permission), class: "permission_forms", method: :put) do |f| %>
                                        <%= f.hidden_field :updated_by, value: current_user.id %>
                                        <%= f.hidden_field :redirect_url, value: account_site_permission_invites_path(@account, @site) %>
                                        <%= f.input :ref_role_slug, collection: @permission_roles, include_blank: false, label: false, input_html: {class: "permission_select"} %>
                                    <% end %>
                                </td>
                                <td style="border: 0px;">
                                    <% if current_user.id != permission.user_id and permission.status != "Deactivated" %>
                                        <%= link_to "x", account_permission_path(@account,   permission, redirect_url: account_site_permission_invites_path(@account, @site)), method: :delete, data: { confirm: 'Are you sure?' } %>
                                    <% end %>
                                </td>
                            </tr>
                        <% end %>
                        <%= paginate @permissions %>
                    </tbody>
                </table>
            <% end %>
            <% if @pending_invites_count != 0 %>
                <br/>
                <h3>Pending Invites</h3>
                <hr/>
                <table class="table">
                    <tbody>
                        <% @permission_invites.each do |permission_invite| %>
                            <tr>
                                <td style="width: 10%; border: 0px;"><img class="rounded" src=<%=avatar_url(permission_invite.email)%>>
                                </td>
                                <td style="border: 0px;">
                                    <%= permission_invite.email %>
                                        <div class="hint">Invited by
                                            <%= permission_invite.creator.name %>
                                                <%= time_ago_in_words (permission_invite.created_at) %>.
                                        </div>
                                </td>
                                <td style="border: 0px;">
                                    <%= link_to "Remove".html_safe, account_permission_invite_path(@account, permission_invite,redirect_url: account_site_permission_invites_path(@account, @site)), method: :delete, data: { confirm: 'Are you sure?' } %>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            <% end %>
        </div>
    </div>
	<div class="col-sm-3 help-text">
        <%= simple_form_for [@account, @permission_invite] do |f| %>
            <% if @permission_invite.errors.any? %>
                <div id="error_explanation" class="ui error message">
                    <div class="header">
                        <%= pluralize(@permission_invite.errors.count, "error") %> prohibited this permission_invite from being saved:
                    </div>
                    <% @permission_invite.errors.full_messages.each do |message| %>
                        <p>
                            <%= message %>
                        </p>
                    <% end %>
                </div>
            <% end %>
            <%= f.hidden_field :permissible_type, value: "Site" %>
            <%= f.hidden_field :permissible_id, value: @site.id %>
            <%= f.hidden_field :created_by, value: current_user.id %>
            <%= f.hidden_field :updated_by, value: current_user.id %>
            <%= f.input :email, id: :permission_invite_email, required: true, autofocus: true %>
            <%= f.hidden_field :redirect_url, value: account_site_permission_invites_path(@account, @site) %>
            <%= f.input :ref_role_slug, collection: @permission_roles, include_blank: false, label: "Role" %>
            <%= f.submit "Invite", class: "btn btn-sm btn-secondary" %>
        <% end %>
        <hr/>
        <%= image_tag "help.png", style: "float: right; right: 0; top: 0; position: relative;" %>
		<h2>Site Roles</h2>
		<p><b>Editors</b> are allowed to everything within this site. They are restricted from changing account settings or adding new sites.</p>
        <p><b>Writers</b> cannot do what Editors cannot do. Additionally, they cannot change site settings, add site team and can see only those folders, cards, streams and pages they create.</p>
        <p><b>Contributors</b> cannot do what Writers cannot do.</p>
	</div>
</div>


<script type="text/javascript">
    $(document).on("turbolinks:load", function(){
        $(".permission_select").on("change", function(){
            $(this).parents('form').submit();
        });
    });
</script>

