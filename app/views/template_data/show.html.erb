<%= render partial: "templates/header_show" %>
<div class="eleven wide column">
  <h3>
    <a class="<%= @template.can_ready_to_publish? ? "ui green ribbon label" : "ui blue ribbon label" %>">
      Step #1
    </a>
    What is this template all about?
  </h3>
  <br/>
  <%= simple_form_for [@account, @template] do |f| %>
    <%= f.error_notification %>
    <div class="form-inputs">
      <%= f.input :elevator_pitch, label: "Describe in 140 characters.", disabled: @template.status == "Published" %>
      <%= f.input :description, as: :text, label: "Describe in detail.", input_html: {rows: 3}, disabled: @template.status == "Published" %>
      <%= f.input :change_log, as: :text, label: "What changed in this version?", placeholder: "Change log", input_html: {rows: 3}, disabled: @template.status == "Published" %>
    </div>
    <div class="form-actions">
      <br/>
      <%= f.button :submit, "Update", class: "ui basic button" %>
    </div>
  <% end %>
  <br/>
  <div class="ui divider"></div>
  <h3>
    <a class="<%= @template.can_ready_to_publish? ? "ui green ribbon label" : "ui blue ribbon label" %>">
      Step #2
    </a>
    Upload mandatory code
  </h3>
  <br/>
  <%= render partial: "services_attachables/form", locals: {services_attachable: @json_schema, label: "Schema definition file", hint: "Format: .json", can_delete: (@template_datum.status != "Published"), content_types: "application/json"} %>
  <%= render partial: "services_attachables/form", locals: {services_attachable: @sample_json, label: "Sample JSON for demo", hint: "Format: .json", can_delete: (@template_datum.status != "Published"), content_types: "application/json"} %>
  <br/>
  <% if @template.can_ready_to_publish? %>
    <div class="ui divider"></div>
    <h3>
      <a class="<%= @template.status != "Draft" ? "ui green ribbon label" : "ui blue ribbon label" %>">Step #3</a>
      Submit the template to Editor for review
    </h3>
    <br/>
    <% if @template.status == "Draft" %>
        <%= link_to "Submit for review", move_to_next_status_account_template_datum_path(@account, @template_datum), class: "ui primary button", style: "color: white !important;" %>
    <% else %>
        <i class="checkmark box icon green" style="font-size: 1.5em;"></i>
    <% end %>
    <br/>
  <% end %>
  <% if @template.status != "Draft" %>
    <div class="ui divider"></div>
    <h3>
      <a class="<%= @template.status != "Draft" ? "ui green ribbon label" : "ui blue ribbon label" %>">Step #4</a>
      Publish the Datacast
    </h3>
    <br/>
    <% if @template.status == "Ready to Publish" %>
        <%= link_to "Publish", move_to_next_status_account_template_datum_path(@account, @template), class: "ui primary button", style: "color: white !important;" %>
    <% else %>
        <i class="checkmark box icon green" style="font-size: 1.5em;"></i>
    <% end %>
    <br/>
  <% end %>
  <% if @template.status == "Published" %>
      <div class="ui divider"></div>
      <h3>
        Push data with APIs
      </h3>
      <br/>
      <table class="ui very basic table">
        <tr>
          <td>My API Key</td>
          <td>:</td>
          <td><%= current_user.access_token %></td>
        </tr>
        <tr>
          <td>Datacast Token:</td>
          <td>:</td>
          <td><%= @template.api_key %></td>
        </tr>
      </table>
      <br/>
      <div class="ui divider"></div>
      <h3>
        <a class="<%= @template.status != "Draft" ? "ui green ribbon label" : "ui blue ribbon label" %>">Step #5</a>
        Connect card templates
      </h3>
      <div style="float: right; font-size: 0.8em; font-weight: 400;">
          <%= link_to "New card template", new_account_template_datum_template_card_path(@account, @template_datum) %>
      </div>
      <br/>
      <%= render partial: "template_cards/index" %>
      <br/>
  <% end %>
  <br/>
  <% if @template.status == "Published" %>
      <div class="ui divider"></div>
      <%= link_to "Make public", flip_public_private_account_template_datum_path(@account, @template_datum), class: "ui button" %>
  <% end %>
  <div class="ui divider"></div>
  <br/>
  <% if @template.status != "Published" %>
  <%= link_to 'Destroy', [@account, @template_datum], method: :delete, data: { confirm: 'Are you sure?' }, class: "ui red basic button" %>
  <% end %>
  <br/><br/><br/><br/>
  <div class="ui dividing right rail" style="min-height: 339px;"></div>
</div>
<div class="five wide column" style="padding-left: 90px;">
  <p style="font-weight: 400; color: gray; margin-bottom: 30px;">
    Last updated by
    <%= @template_datum.updator.name %>
    <%= time_ago_in_words @template_datum.updated_at %>
  </p>
  <div class="ui list">
    <% if @template.status == "Published" %>
    <%= link_to "Create Bug Version", create_version_account_template_datum_path(@account, @template, version_genre: "bug"), class: "item" %>
    <%= link_to "Create Major Version", create_version_account_template_datum_path(@account, @template, version_genre: "major"), class: "item" %>
    <%= link_to "Create Minor Version", create_version_account_template_datum_path(@account, @template, version_genre: "minor"), class: "item" %>
    <br/>
    <% end %>

    <% last_series = nil %>
    <% @siblings.each do |s| %>
    <% if last_series != s.version_series %>
    <div class="item" style="margin-bottom: 5px;">
      <i class="folder icon"></i>
      <div class="content">
        <div class="header">
          SERIES: <%= s.version_series %>
        </div>
      </div>
    </div>
    <% end %>
    <div class="item" style="margin-left: 20px; ">
      <div class="content">
        <div class="header">
          <a href=<%= account_template_datum_path(@account, s) %> style="<%= s.id == @template_datum.id ? "color: orange !important;" : "" %>">
            <% if s.is_current_version %>
            <i class="checkmark icon" style="color: green; padding-top: 5px; font-size: 15px;"></i>
            <% elsif s.version_genre == "bug" %>
            <i class="bug icon" style="padding-top: 5px;"></i>
            <% elsif s.version_genre == "major" %>
            <i class="cubes icon" style="padding-top: 5px;"></i>
            <% elsif s.version_genre == "minor" %>
            <i class="cube icon" style="padding-top: 5px;"></i>
            <% end %>
            <%= s.version.to_s %>
            <div class="ui label"><%= s.status %></div>
          </a>
        </div>
      </div>
    </div>
    <% last_series = s.version_series %>
    <% end %>
  </div>
</div>
</div>

<script type="text/javascript">
  $(document).on('turbolinks:load', function (e) {
    $("input:file").on('change', function() {
      if (validate_file($(this)[0].files[0].type, $(this).attr("accept"))) {
        $(this).parents('form').submit();
      } else {
        generate_notify({text: `Invalid file type.`, notify: "error"})
        return false;
      }
    });

    $(".browse_file").on('click', function(event){
      $(this).siblings('div.file').children("input").click();
      event.preventDefault();
    });
  });
  var validate_file = function(file_type, accepted_type) {
    return (accepted_type.split(",").indexOf(file_type) >= 0)
  }
</script>
