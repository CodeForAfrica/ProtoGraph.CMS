<%= render partial: "stories/stories_header" %>
<div class="row">
    <p>
        The Article page has 3 streams: Cover, Narrative and 3-column. To edit the name of the 3-column stream, simply click on it, a text box will appear. The left most column has 'all published stories and cards'. The best way to find a story or card is to fetch it's card ID and Ctrl+F search it by id. To add a story or card to a stream, hover over it to unveil the list of streams and click on relevant stream. To remove a story from a stream, click on Remove link. All cards and stories will be sorted by published datetime.
    </p>
    <br/>
</div>
<div class="row">
    <div class="col-sm-4" style="background: #37474F; padding: 30px 0px;">
        <h4 style="text-align: center; color: white;">All stories and cards</h4>
        <br/>
        <% @all_cards.each do |d| %>
          <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" style='width: 180px; margin-bottom: 10px; margin-left: 50%; transform: translate(-50%,0%); '>
            <div class="card-information">
              <div class="card-title"><%= truncate(d.name, length: 200, ommission: "..") %></div>
              <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
              <div class="card-footer">
                <div class="users-list">
                  <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                </div>
                <div class="due-on">
                  <%= time_ago_in_words(d.updated_at) %>
                </div>
              </div>
            </div>
            <div class="call-to-action">
              <% if (d.is_autogenerated and d.page.present?) %>
                <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                <% else %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                <% end %>
              <% else %>
                <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                <% end %>
              <% end %>
            </div>
            <div class="action-move-to">
              <div class="hint-text">Move To</div>
              <br>
              <ul class="list-group list-group-flush">
                <% if (["col16", "col4"] - d.template_card.allowed_views).blank? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_16) %>"><%= @page_streamH16.name_of_stream %></li>
                <% end %>
                <% if (["col7", "col4"] - d.template_card.allowed_views).blank? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_narrative) %>"><%= @page_stream_narrative7c.name_of_stream %></li>
                <% end %>

                <% if (d.template_card.allowed_views & ["col4"]).present? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_related) %>"><%= @page_stream_related7c.name_of_stream %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>
    </div>
    <div class="col-sm-4" style="background: #90A4AE; padding: 30px 0px;">
        <h4 style="color: white; text-align: center;">
            <h4 style='text-align: center;'>Cover or Hero stream</h4>
            <%= link_to ".", publish_site_stream_path(@site, @page_stream_16, folder_id: @folder.blank? ? nil : @folder.id),"data-turbolinks"=> false, method: :post, style: 'color: #90A4AE' %>
        </h4>
        <br/>
        <% @page_stream_16.cards.each do |d| %>
          <% stream_entity = @page_stream_16.stream_entities.view_casts.where(entity_value: d.id).first %>
          <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" data-stream-entity-id="<%= stream_entity.id %>" style='width: 180px; margin-bottom: 10px; margin-left: 50%; transform: translate(-50%,0%); '>
            <div class="card-information">
              <div class="card-title"><%= truncate(d.name, length: 200, ommission: "..") %></div>
              <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
              <div class="card-footer">
                <div class="users-list">
                  <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                </div>
                <div class="due-on">
                  <%= time_ago_in_words(d.updated_at) %>
                </div>
              </div>
            </div>
            <div class="call-to-action">
              <% if (d.is_autogenerated and d.page.present?) %>
                <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                <% else %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                <% end %>
              <% else %>
                <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                <% end %>
              <% end %>
            </div>
            <div class="action-move-to">
              <div class="hint-text">Move To</div>
              <div class="remove-button">
                <%= link_to "Remove", [@site, @page_stream_16, stream_entity ], method: :delete %>
              </div>
              <br>
              <ul class="list-group list-group-flush">
                <% if (["col7", "col4"] - d.template_card.allowed_views).blank? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_narrative) %>"><%= @page_stream_narrative7c.name_of_stream %></li>
                <% end %>

                <% if (d.template_card.allowed_views & ["col4"]).present? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_related) %>"><%= @page_stream_related7c.name_of_stream %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>
    </div>
    <div class="col-sm-4" style="background: #B0BEC5; padding: 30px 0px;">
        <h4 style="color: black; text-align: center;">
            <h4 style='text-align: center;'>Narrative stream</h4>
            <%= link_to ".", publish_site_stream_path(@site, @page_stream_narrative, folder_id: @folder.blank? ? nil : @folder.id),"data-turbolinks"=> false, method: :post, style: "color: #B0BEC5" %>
        </h4>
        <br/>
        <% @page_stream_narrative.cards.each_with_index do |d, i| %>
          <% stream_entity = @page_stream_narrative.stream_entities.view_casts.where(entity_value: d.id).first %>
          <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" data-stream-entity-id="<%= stream_entity.id %>" style='width: 180px; margin-bottom: 10px; margin-left: 50%; transform: translate(-50%,0%); '>
            <div class="card-information">
              <div class="card-title"><%= truncate(d.name, length: 200, ommission: "..") %></div>
              <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
              <div class="card-footer">
                <div class="users-list">
                  <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                </div>
                <div class="due-on">
                  <%= time_ago_in_words(d.updated_at) %>
                </div>
              </div>
            </div>
            <div class="call-to-action">
              <% if (d.is_autogenerated and d.page.present?) %>
                <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                <% else %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                <% end %>
              <% else %>
                <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                <% end %>
              <% end %>
            </div>
            <div class="action-move-to">
              <div class="hint-text">
                Move
                <% if i != 0  %>
                  &nbsp
                  <%= link_to image_tag('up.png', height: 10), move_up_site_stream_stream_entity_path(@site, @page_stream_narrative, stream_entity), method: :put %>
                <% end %>
                <% if i != (@page_stream_narrative.cards.count - 1)%>
                  &nbsp
                  <%= link_to image_tag('down.png', height: 10), move_down_site_stream_stream_entity_path(@site, @page_stream_narrative, stream_entity), method: :put %>
                <% end %>
              </div>
              <div class="remove-button">
                <%= link_to "Remove", [@site, @page_stream_narrative, stream_entity], method: :delete %>
              </div>

              <br>
              <ul class="list-group list-group-flush">
                <% if (["col16", "col4"] - d.template_card.allowed_views).blank? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_16) %>"><%= @page_streamH16.name_of_stream %></li>
                <% end %>
                <% if (d.template_card.allowed_views & ["col4"]).present? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_related) %>"><%= @page_stream_related7c.name_of_stream %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>
    </div>
    <div class="col-sm-4" style="background: #CFD8DC; padding: 30px 0px;">
        <h4 style='text-align: center;'>3-column stream</h4>
        <h4 style="color: black; text-align: center;">
            Title:
            <%= best_in_place @page_stream_related7c, :name_of_stream, url: [@site, @page_stream_related7c], style: "border-bottom: 1px dotted black;" %>
            <%= link_to ".", publish_site_stream_path(@site, @page_stream_related, folder_id: @folder.blank? ? nil : @folder.id),"data-turbolinks"=> false, method: :post, style: "color: #CFD8DC" %>
        </h4>
        <br/>
        <% @page_stream_related.cards.each_with_index  do |d, i| %>
          <% stream_entity = @page_stream_related.stream_entities.view_casts.where(entity_value: d.id).first %>
          <div class="card-as-a-todo move-to-action" data-view-cast-id="<%= d.id %>" data-stream-entity-id="<%= stream_entity.id %>" style='width: 180px; margin-bottom: 10px; margin-left: 50%; transform: translate(-50%,0%); '>
            <div class="card-information">
              <div class="card-title"><%= truncate(d.name, length: 200, ommission: "..") %></div>
              <div class="card-type"><%= d.template_card.name %> <span class="card-id">#<%=d.id.to_s%></span></div>
              <div class="card-footer">
                <div class="users-list">
                  <div class="single-user"><%= image_tag avatar_url(d.updator.email), width: "16px", height: "16px" %></div>
                </div>
                <div class="due-on">
                  <%= time_ago_in_words(d.updated_at) %>
                </div>
              </div>
            </div>
            <div class="call-to-action">
              <% if (d.is_autogenerated and d.page.present?) %>
                <% if (d.page.template_page.name == 'Homepage: Vertical') %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, distribute_site_page_path(@site, d.page), "data-turbolinks" => false %>
                <% else %>
                  <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe,edit_distribute_site_story_path(@site, d.page, folder_id: d.folder.id), "data-turbolinks" => false %>
                <% end %>
              <% else %>
                <%= link_to "<div class='action-button action-preview'>Preview</div>".html_safe, [@site, d.folder, d], "data-turbolinks" => false %>
                <% unless (d.template_card.name == 'toParagraph' and d.is_autogenerated == true) %>
                  <%= link_to "<div class='action-button action-edit'>Edit</div>".html_safe, edit_site_folder_view_cast_path(@site, d.folder, d), "data-turbolinks" => false %>
                <% end %>
              <% end %>
            </div>
            <div class="action-move-to">
              <div class="hint-text">
                Move
                <% if i != 0  %>
                  &nbsp
                  <%= link_to image_tag('up.png', height: 10), move_up_site_stream_stream_entity_path(@site, @page_stream_related, stream_entity), method: :put %>
                <% end %>
                <% if i != (@page_stream_related.cards.count - 1)%>
                  &nbsp
                  <%= link_to image_tag('down.png', height: 10), move_down_site_stream_stream_entity_path(@site, @page_stream_related, stream_entity), method: :put %>
                <% end %>
              </div>
              <div class="remove-button">
                <%= link_to "Remove", [@site, @page_stream_related, stream_entity ], method: :delete %>
              </div>

              <br>
              <ul class="list-group list-group-flush">
                <% if (["col16", "col4"] - d.template_card.allowed_views).blank? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_16) %>"><%= @page_streamH16.name_of_stream %></li>
                <% end %>
                <% if (["col7", "col4"] - d.template_card.allowed_views).blank? %>
                  <li class="list-group-item" data-page-stream-url="<%= site_stream_stream_entities_path(@site, @page_stream_narrative) %>"><%= @page_stream_narrative7c.name_of_stream %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>
    </div>
</div>

<%= simple_form_for(@stream_entity, url: [@site, @page_stream_related, @stream_entity]) do |f| %>
    <%= f.hidden_field :entity_value, id: "stream_view_cast_id" %>
    <%= f.hidden_field :entity_type, value: "view_cast_id" %>
    <%= f.hidden_field :is_excluded, value: false %>
    <%= f.hidden_field :page_id, value: @page.id %>
    <%= f.hidden_field :remove_stream_entity_id, id: "remove_stream_entity_id" %>
<% end %>


<script type="text/javascript">
    $(document).on("turbolinks:load",function() {
      $('.proto-tagged-input').tagsinput();
      $('.action-move-to .list-group li').off('click')
      $('.action-move-to .list-group li').on('click', function(){
        $("#new_stream_entity").attr("action", this.dataset.pageStreamUrl);
        $("#stream_view_cast_id").val($(this).parents('.card-as-a-todo').data().viewCastId);
        if($(this).parents('.card-as-a-todo').data().streamEntityId) {
          $("#remove_stream_entity_id").val($(this).parents('.card-as-a-todo').data().streamEntityId)
        }
        $("#new_stream_entity").submit();
      })
    });
    function readURL(input) {
     if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          $(input).css('background', 'transparent url('+e.target.result +') left top no-repeat');
        }
        reader.readAsDataURL(input.files[0]);
      }
    };
</script>